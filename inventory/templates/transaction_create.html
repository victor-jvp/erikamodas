{% extends 'base.html' %} {% block content %}
{% load static %}

<h1>Transacción Nueva</h1>

<div class="card mt-3">
    <div class="card-body">
        <form action="{% url 'product:transaction_create' %}" method="post">
            {% csrf_token %}

            <div class="mb-3">
                <label for="type" class="form-label">Tipo de Transacción</label>
                <div class="input-group">
                    <select type="text" class="form-select {% if errors.type %}is-invalid{% endif %}" 
                        name="type" id="type"
                        placeholder="..." aria-label="..." aria-describedby="button-addon2">
                        {% for item in types %}
                        <option value="{{ item.id }}">{{ item.name }}</option>
                        {% empty %}
                        <option value="">-No se encontraron registros-</option>
                        {% endfor %}
                    </select>
                    <div class="invalid-feedback">
                    {% if errors.type %}
                    {% for error in errors.type %}
                        {{ error.message }}
                    {% endfor %}
                    {% endif %}       
                    </div>                    
                </div>
            </div>

            <div class="mb-3">
                <label for="category" class="form-label">Categoria</label>
                <div class="input-group">
                    <select type="text" class="form-select {% if errors.name %}is-invalid{% endif %}" 
                        name="category" id="category"
                        placeholder="..." aria-label="..." aria-describedby="button-addon2">
                        {% for item in categories %}
                        {% if forloop.first %}
                        <option value="">-Seleccione-</option>
                        {% endif %}
                        <option value="{{ item.id }}">{{ item.name }}</option>
                        {% empty %}
                        <option value="">-No se encontraron registros-</option>
                        {% endfor %}
                    </select>
                    <div class="invalid-feedback">
                    {% if errors.category %}
                    {% for error in errors.category %}
                        {{ error.message }}
                    {% endfor %}
                    {% endif %}       
                    </div>                    
                </div>
            </div>
            
            <div class="mb-3">
                <label for="product" class="form-label">Producto</label>
                <div class="input-group">
                    <select type="text" class="form-select" name="product" id="product" required>
                        <option value="" selected>-Seleccione la categoria-</option>
                    </select>                
                </div>
            </div>

            <div class="mb-3">
                <label for="stock" class="form-label">Stock</label>
                <input type="number" class="form-control {% if errors.name %}is-invalid{% endif %}" 
                    name="stock" id="stock" placeholder="0.00" required>
                <div class="invalid-feedback">
                {% if errors.stock %}
                {% for error in errors.stock %}
                    {{ error.message }}
                {% endfor %}
                {% endif %}       
                </div>
            </div>

            <button type="submit" class="btn btn-outline-success"><i class="fa fa-save"></i> Guardar</button>
            <a href="{% url 'product:index' %}" class="btn btn-outline-secondary"><i class="fa fa-undo"></i> Volver</a>
        </form>
    </div>
</div>

<script>
    let category = $("#category"),
        products = $("#product")

    $(document).ready(function() {
        
        category.change(function() {
            get_products(category.val())
        })

        
    })

    function get_products(category_id)
    {
        $.ajax({
            type: 'GET',
            url: "/inventory/ajax/products-by-category",
            data: {
                category_id: category_id
            },
            success: (resp) => {
                let options = ""
                if(resp.length > 0) {
                    resp.forEach((e) => {
                        options += `<option value="${e.id}">${e.name}</option>`
                    })
                }else{
                    options = `<option value="" selected>-Sin productos registrados-</option>`
                }
                products.empty().append(options)
            },
            error: (resp) => {
                console.error(resp)
            }
        })
    }
</script>

{% endblock %}

{% block custom_css %}

{% endblock custom_css %}

{% block custom_js %}

{% endblock custom_js %}